 {% extends 'shop/base.html' %}
{% load static %}
{% block content %}

<!-- Inline styles scoped to the cart page for quick integration -->
<style>
  /* Preloader overlay (white) */
  #cartPreloader {
    position: fixed;
    inset: 0;
    background: #ffffff;
    z-index: 10800;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:14px;
    transition: opacity .5s ease, visibility .5s ease;
  }
  #cartPreloader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

  .preloader-badge { font-weight:700; font-size:1.1rem; color:#071027; letter-spacing:0.6px; }
  .preloader-ring {
    width:56px; height:56px; border-radius:50%;
    border:6px solid rgba(7,16,39,0.06);
    border-top-color: #ffd27a;
    animation: spin .95s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Page container tweaks */
  .cart-hero {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:18px;
    gap:12px;
  }
  .cart-hero h3 { margin:0; font-weight:800; letter-spacing:-0.2px; }

  /* Cart card */
  .cart-card {
    background: linear-gradient(180deg,#ffffff,#fbfbfd);
    border-radius:14px;
    padding:18px;
    box-shadow: 0 18px 50px rgba(2,6,23,0.06);
  }

  /* Table styling */
  .cart-table {
    width:100%;
    border-collapse:collapse;
  }
  .cart-table thead th {
    border-bottom: 1px solid rgba(11,18,32,0.06);
    padding:12px 10px;
    text-align:left;
    font-weight:700;
    color:#0b1220;
    background: transparent;
  }
  .cart-table tbody tr {
    transition: transform .5s cubic-bezier(.2,.9,.3,1), opacity .5s;
    transform: translateY(14px);
    opacity: 0;
  }
  .cart-table tbody tr.visible {
    transform: none;
    opacity: 1;
  }
  .cart-table td {
    padding:12px 10px;
    vertical-align: middle;
    border-bottom: 1px dashed rgba(11,18,32,0.04);
  }

  .product-cell {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .product-thumb {
    width:72px;
    height:72px;
    object-fit:cover;
    border-radius:10px;
    box-shadow: 0 8px 20px rgba(2,6,23,0.06);
  }
  .product-title { font-weight:700; margin:0; font-size:0.98rem; color:#071027; }
  .product-sub { margin:0; font-size:.88rem; color:#6b7280; }

  /* Qty badge */
  .qty-badge {
    display:inline-block;
    min-width:40px;
    text-align:center;
    border-radius:8px;
    padding:6px 8px;
    background:#f8fafc;
    color:#0b1220;
    font-weight:600;
    box-shadow: inset 0 -2px 0 rgba(11,18,32,0.02);
  }

  /* Remove button */
  .btn-remove {
    border-radius:10px;
    padding:.42rem .6rem;
    font-size:.85rem;
  }

  /* Total box */
  .total-box {
    background: linear-gradient(180deg,#fff,#f8fafc);
    padding:18px;
    border-radius:12px;
    box-shadow: 0 14px 40px rgba(2,6,23,0.04);
  }
  .total-line { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
  .total-amount { font-size:1.35rem; font-weight:800; color:#071027; }

  /* CTA */
  .btn-checkout {
    border-radius:12px;
    padding:.75rem 1.2rem;
    font-weight:700;
    box-shadow: 0 16px 44px rgba(2,6,23,0.14);
  }

  /* Empty cart */
  .empty-cart {
    text-align:center;
    padding:36px;
    border-radius:12px;
    background:#fff;
    box-shadow: 0 12px 36px rgba(2,6,23,0.04);
  }

  /* Responsive */
  @media (max-width: 767px) {
    .hero-left { width:100%; }
    .product-thumb { width:56px; height:56px; }
    .cart-hero { flex-direction:column; align-items:flex-start; gap:8px; }
  }
</style>

<!-- Preloader -->
<div id="cartPreloader" role="status" aria-live="polite">
  <div class="preloader-badge">Jwellery</div>
  <div class="preloader-ring" aria-hidden="true"></div>
  <div class="small text-muted">Preparing your cart…</div>
</div>

<div class="cart-card">
  <div class="cart-hero">
    <div>
      <h3>Your Cart</h3>
      <div class="small text-muted">Review the items before checkout</div>
    </div>

    {% if items %}
      <div class="small text-muted">Items: <strong>{{ items|length }}</strong></div>
    {% endif %}
  </div>

  {% if items %}
    <div class="table-responsive">
      <table class="cart-table">
        <thead>
          <tr>
            <th>Product</th>
            <th style="width:110px">Qty</th>
            <th style="width:140px">Subtotal</th>
            <th style="width:120px">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="cart-row">
              <td>
                <div class="product-cell">
                  {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="product-thumb">
                  {% else %}
                    <img src="{% static 'shop/images/g1.jpeg' %}" alt="{{ item.product.name }}" class="product-thumb">
                  {% endif %}
                  <div>
                    <p class="product-title">{{ item.product.name }}</p>
                    <p class="product-sub">₹ {{ item.product.price }}</p>
                  </div>
                </div>
              </td>

              <td>
                <div class="d-flex align-items-center">
                  <div class="qty-badge" aria-live="polite">{{ item.quantity }}</div>
                </div>
              </td>

              <td>
                <div class="fw-bold">₹ {{ item.subtotal }}</div>
              </td>

              <td>
                <form action="{% url 'shop:remove_from_cart' item.pk %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger btn-remove">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row mt-3 g-3">
      <div class="col-md-6">
        <div class="total-box">
          <div class="total-line"><div class="text-muted">Subtotal</div><div>₹ {{ total }}</div></div>
          <div class="total-line"><div class="text-muted">Shipping</div><div class="text-muted">Calculated at checkout</div></div>
          <hr>
          <div class="total-line"><div class="text-muted">Total</div><div class="total-amount">₹ {{ total }}</div></div>
        </div>
      </div>

      <div class="col-md-6 d-flex align-items-center justify-content-md-end">
        <a href="{% url 'shop:checkout' %}" class="btn btn-lg btn-primary btn-checkout">Proceed to Checkout</a>
      </div>
    </div>

  {% else %}
    <div class="empty-cart">
      <h5 class="mb-2">Your cart is empty</h5>
      <p class="text-muted mb-3">Browse our collection and add beautiful pieces to your cart.</p>
      <a href="{% url 'shop:product_list' %}" class="btn btn-primary">Shop Products</a>
    </div>
  {% endif %}
</div>

<!-- page scripts (reveal animation + hide preloader) -->
<script>
  (function(){
    // Hide preloader once content is interactive
    const pre = document.getElementById('cartPreloader');
    function hidePre() {
      if (!pre) return;
      pre.classList.add('hidden');
      setTimeout(()=> { if (pre.parentNode) pre.parentNode.removeChild(pre); }, 650);
    }

    // On window load hide preloader and animate rows
    window.addEventListener('load', function () {
      // stagger reveal for cart rows
      const rows = document.querySelectorAll('.cart-row');
      rows.forEach((r, i) => {
        setTimeout(() => r.classList.add('visible'), 90 * i);
      });

      // small bounce for total box and checkout button
      const totalBox = document.querySelector('.total-box');
      const checkout = document.querySelector('.btn-checkout');
      if (totalBox) { totalBox.style.transform = 'translateY(10px)'; totalBox.style.opacity = '0'; setTimeout(()=> { totalBox.style.transition = 'all .6s cubic-bezier(.2,.9,.3,1)'; totalBox.style.transform='none'; totalBox.style.opacity='1'; }, 300); }
      if (checkout) { checkout.style.transform = 'translateY(18px)'; checkout.style.opacity = '0'; setTimeout(()=> { checkout.style.transition = 'all .6s cubic-bezier(.2,.9,.3,1)'; checkout.style.transform='none'; checkout.style.opacity='1'; }, 420); }

      hidePre();
    });

    // In case load already happened
    if (document.readyState === 'complete') {
      // mimic load event (ensure animations still run)
      const event = new Event('load');
      window.dispatchEvent(event);
    }
  })();
</script>

{% endblock %}
